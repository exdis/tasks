/* exdisme - v0.0.1 - 2014-05-25 */
define(["angular","services","jquery","moment"],function(a,b,c,d){"use strict";var e=a.module("app.controllers",["app.services"]);e.controller("ctrl",["$scope","Tasks","TasksDate","$http","$route",function(b,e,f,g){b.init=function(a,c){b.page=a,"undefined"!=typeof b.currentUser&&(("undefined"==typeof b.month||b.month<0)&&(b.month=d().get("month")),"undefined"==typeof c&&e.get({id:b.currentUser,page:a},function(c){b.count=c.count,b.tasks=c.tasks,b.pageTotal=Math.ceil(parseInt(b.count)/20),b.pagination={cur:a,total:b.pageTotal,display:10},b.loading=!1}),f.get({id:b.currentUser,year:d().get("year"),month:b.month+1},function(a){b.datedTasks=a,b.total(b.month)}))},b.total=function(c){var e=0;a.forEach(b.datedTasks,function(a){e+=parseInt(a.time)});var f,g=d.duration(e);f="In "+d(d().get("year")+" "+(c+1)).format("MMMM")+" you have ",f+=Math.floor(g.asHours())+"hours "+g.get("minutes")+"minutes "+g.get("seconds")+"seconds",f+=" ("+g.asHours()*b.settings.cost+" rubles)",b.timeEntries=f},b.prevMonth=function(){b.month-=1,b.init(b.page,!0)},b.currentMonth=function(){b.month=d().get("month"),b.init(b.page,!0)},b.submit=function(){var a=b.form,e=[!1,!1,!1];c("#new form input").each(function(a){if(c(this).val())if(c(this).hasClass("time")){var b=c(this).val();b.match(/\d+[hms]/)&&(c(this).parent(".form-group").removeClass("has-error"),e[a]=!0)}else c(this).parent(".form-group").removeClass("has-error"),e[a]=!0;else c(this).parent(".form-group").addClass("has-error"),e[a]=!1});for(var f=!0,h=0;h<e.length;h++)e[h]||(f=!1);if(f){var i=a.time.match(/\d+h/),j=a.time.match(/\d+m/),k=a.time.match(/\d+s/),l=d.duration({hours:i?parseInt(i[0].replace("h","")):0,minutes:j?parseInt(j[0].replace("m","")):0,seconds:k?parseInt(k[0].replace("s","")):0});a.time=l.asMilliseconds(),a.userid=b.currentUser,g.post("api/tasks",JSON.stringify(a)).success(function(a){"OK"===a.status&&(c("#new").modal("hide"),c(".navbar-collapse").hasClass("in")&&c(".navbar-toggle").click(),b.init(b.pagination.cur),b.form={})})}},b.submitSettings=function(){var a=b.settings;g.put("api/users/"+b.currentUser,JSON.stringify(a)).success(function(a){"OK"===a.status&&(c("#settings").modal("hide"),c(".navbar-collapse").hasClass("in")&&c(".navbar-toggle").click(),b.total(b.month))})},b.taskDelete=function(){console.log(b.tasktoremove);var a="undefined"!=typeof b.tasktoremove?b.tasktoremove:"";g.delete("api/tasks/"+a);var d=b.tasks.indexOf(a);b.tasks.splice(d,1),c("#confirm").modal("hide"),c(".navbar-collapse").hasClass("in")&&c(".navbar-toggle").click(),b.init(b.pagination.cur)}}])});